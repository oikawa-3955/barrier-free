<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>都市大バリアフリーマップ</title>
    <style>
      body { margin: 0; padding: 0; font-family: sans-serif; }
      #map { height: 100vh; width: 100%; }

      /* --- UI: フィルタボタン（左上） --- */
      .filter-container {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 5;
        display: flex;
        gap: 8px;
      }
      .btn {
        background: white;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        font-weight: bold;
        cursor: pointer;
        font-size: 13px;
      }
      .btn:active { background: #eee; }
      .btn-blue { color: #007bff; border: 2px solid #007bff; }
      .btn-all { color: #333; }

      /* --- UI: 現在地ボタン（右下） --- */
      .gps-btn {
        position: absolute;
        bottom: 120px; /* Googleロゴと重ならないよう少し上へ */
        right: 15px;
        z-index: 5;
        background: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        cursor: pointer;
        font-size: 24px;
        display: flex; align-items: center; justify-content: center;
        color: #555;
      }
      .gps-btn:active { background: #eee; }
    </style>
  </head>
  <body>
    
    <div class="filter-container">
      <button class="btn btn-all" onclick="filterMap('all')">すべて</button>
      <button class="btn btn-blue" onclick="filterMap('accessible')">♿ バリアフリーのみ</button>
    </div>

    <button class="gps-btn" onclick="centerMyLocation()">◎</button>

    <div id="map"></div>

    <script>
      let map;
      let markers = []; // 全スポットのピンを管理する配列
      
      // 現在地関連の変数
      let myMarker = null;
      let myAccuracyCircle = null;
      let watchId = null;

      function initMap() {
        // 初期座標（都市大）
        const targetLocation = { lat: 35.598352, lng: 139.650828 };

        // 地図生成
        map = new google.maps.Map(document.getElementById("map"), {
          center: targetLocation,
          zoom: 17,
          disableDefaultUI: true, // デフォルトUIを消してアプリっぽく
          zoomControl: true,      // ズームボタンは残す
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false
        });

        // --- データ定義 ---
        const spots = [
          { name: "東京都市大学 世田谷キャンパス", lat: 35.598352, lng: 139.651045, status: 0 },
          { name: "1号館", lat: 35.599108, lng: 139.650828, status: 1 },
          { name: "2号館", lat: 35.599256, lng: 139.651566, status: 1 },
          { name: "3号館", lat: 35.598915, lng: 139.651366, status: 1 },
          { name: "図書館（バリアフリー）", lat: 35.598500, lng: 139.650900, status: 0 },
          { name: "4号館", lat: 35.598673, lng: 139.651166, status: 1 },
        ];

        // --- ピンを立てるループ処理 ---
        spots.forEach((spot) => {
          let iconUrl = null; // デフォルトは赤ピン(null)

          // バリアフリー(status:0)なら青アイコン
          if (spot.status === 0) {
            iconUrl = "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"; 
          }

          const marker = new google.maps.Marker({
            position: { lat: spot.lat, lng: spot.lng },
            map: map,
            title: spot.name,
            icon: iconUrl, 
          });

          // フィルタリング用にstatus情報をマーカーに埋め込む
          marker.customStatus = spot.status;

          // クリック時の吹き出し
          const infoWindow = new google.maps.InfoWindow({
            content: `<div style="padding:5px; font-weight:bold;">${spot.name}</div>`
          });
          marker.addListener("click", () => {
            infoWindow.open(map, marker);
          });

          // 配列に保存（あとでフィルタ操作するため）
          markers.push(marker);
        });

        // --- アプリ起動時に現在地追跡を開始 ---
        startTracking();
      }

      // --- 機能1: フィルタリング ---
      function filterMap(type) {
        markers.forEach((marker) => {
          if (type === 'all') {
            marker.setVisible(true);
          } else if (type === 'accessible') {
            // statusが0なら表示、それ以外は非表示
            marker.setVisible(marker.customStatus === 0);
          }
        });
      }

      // --- 機能2: リアルタイム現在地追跡 ---
      function startTracking() {
        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              const currentPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              const accuracy = position.coords.accuracy;

              // 初回作成または位置更新
              if (!myMarker) {
                // 自分用マーカー（青い丸）
                myMarker = new google.maps.Marker({
                  position: currentPos,
                  map: map,
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: "#4285F4",
                    fillOpacity: 1,
                    strokeColor: "white",
                    strokeWeight: 2,
                  },
                  zIndex: 999
                });
                // 誤差円
                myAccuracyCircle = new google.maps.Circle({
                  map: map,
                  center: currentPos,
                  radius: accuracy,
                  fillColor: "#4285F4",
                  fillOpacity: 0.1,
                  strokeColor: "#4285F4",
                  strokeOpacity: 0.3,
                  strokeWeight: 1,
                  zIndex: 998
                });
              } else {
                // 既にマーカーがある場合は移動させる
                myMarker.setPosition(currentPos);
                myAccuracyCircle.setCenter(currentPos);
                myAccuracyCircle.setRadius(accuracy);
              }
            },
            (error) => {
              console.warn("位置情報エラー: " + error.message);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        }
      }

      // --- 機能3: ボタンで現在地へ移動 ---
      function centerMyLocation() {
        if (myMarker) {
          map.panTo(myMarker.getPosition());
          map.setZoom(18); // ズームイン
        } else {
          alert("現在地を取得中です...");
        }
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATB9-p7wIeRz1W0ZKvKtkNCRMokUxb5aw&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>