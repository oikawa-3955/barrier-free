<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>リアルタイム現在地マップ</title>
    <style>
      body { margin: 0; padding: 0; font-family: sans-serif; }
      #map { height: 100vh; width: 100%; }

      .gps-btn {
        position: absolute;
        bottom: 25px;
        right: 10px;
        z-index: 5;
        background: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        cursor: pointer;
        font-size: 24px;
        /* ボタンを押した感触を出す */
        display: flex; align-items: center; justify-content: center;
      }
      .gps-btn:active { background: #eee; }
    </style>
  </head>
  <body>
    <button class="gps-btn" onclick="toggleTracking()">◎</button>

    <div id="map"></div>

    <script>
      let map;
      let myMarker = null; // 自分の位置を示すマーカー
      let myAccuracyCircle = null; // 誤差範囲を示す円
      let watchId = null; // 追跡プロセスID（止める時に使う）
      let isTracking = false; // 今、自動追尾しているかどうか

      function initMap() {
        // 初期表示位置（とりあえず大学）
        const targetLocation = { lat: 35.598352, lng: 139.650828 };

        map = new google.maps.Map(document.getElementById("map"), {
          center: targetLocation,
          zoom: 17,
          disableDefaultUI: true,
          zoomControl: true,
        });

        // ピン（スポット）の表示など他の処理はここに書く...
        // 今回は省略
        
        // ★アプリ起動と同時に位置情報追跡を開始するならここに入れる
        startTracking();
      }

      // --- ★ここからリアルタイム追跡の心臓部 ---

      function startTracking() {
        if (navigator.geolocation) {
          // watchPosition: 位置が変わるたびに success関数 が呼ばれる
          watchId = navigator.geolocation.watchPosition(
            success, 
            error, 
            {
              enableHighAccuracy: true, // 高精度モード（バッテリー消費増だが正確）
              timeout: 5000,            // 5秒以内に反応がなければ諦める
              maximumAge: 0             // 常に最新の情報を取る（キャッシュしない）
            }
          );
          isTracking = true;
        } else {
          alert("このブラウザは位置情報に対応していません。");
        }
      }

      // 位置情報の取得に成功した時に何度も呼ばれる関数
      function success(position) {
        const currentPos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };
        const accuracy = position.coords.accuracy; // 誤差（メートル）

        // 1. 自分マーカーがまだ無ければ作る
        if (!myMarker) {
          // 青い丸（Googleマップ風のデザイン）
          myMarker = new google.maps.Marker({
            position: currentPos,
            map: map,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8, // 丸の大きさ
              fillColor: "#4285F4", // Googleブルー
              fillOpacity: 1,
              strokeColor: "white", // 白い縁取り
              strokeWeight: 2,
            },
            title: "現在地",
            zIndex: 999 // 他のピンより手前に表示
          });

          // 誤差を示す薄い円
          myAccuracyCircle = new google.maps.Circle({
            map: map,
            center: currentPos,
            radius: accuracy, // 精度(m)を半径にする
            fillColor: "#4285F4",
            fillOpacity: 0.2, // 薄くする
            strokeColor: "#4285F4",
            strokeOpacity: 0.4,
            strokeWeight: 1,
            zIndex: 998 
          });

          // 初回だけ地図の中心を移動
          map.panTo(currentPos);

        } else {
          // 2. 既にマーカーがあるなら、位置だけ更新する（アニメーションでヌルっと動く）
          myMarker.setPosition(currentPos);
          myAccuracyCircle.setCenter(currentPos);
          myAccuracyCircle.setRadius(accuracy);
          
          // 追跡モード中なら、地図の中心も移動させ続ける
          if (isTracking) {
             map.panTo(currentPos);
          }
        }
      }

      function error(e) {
        console.warn("位置情報の取得エラー: " + e.message);
      }

      // ボタンを押した時の処理（地図の中心を自分に戻す）
      function toggleTracking() {
        isTracking = true; // 追跡フラグをON
        // もしマーカーがあればそこへ移動
        if (myMarker) {
          map.panTo(myMarker.getPosition());
          map.setZoom(18);
        } else {
          startTracking(); // まだ開始してなければ開始
        }
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATB9-p7wIeRz1W0ZKvKtkNCRMokUxb5aw&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>